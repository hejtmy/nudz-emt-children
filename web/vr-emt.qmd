---
title: "VR Children EMT test Reports"
format: html
---

```{r setup, echo=FALSE, warning=FALSE, message=FALSE, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE)
library(tidyverse)
library(gt)
here::i_am("web/vr-emt.qmd")
```

```{r loading, message=FALSE, warning=FALSE}
source(here::here("scripts/loading.R"))
df_vr_all <- df_vr
df_vr <- df_vr %>%
  filter(difficulty > 3,
  !(error_type %in% c("total_error", "incorrect_location_order")))
```

## Removig the 3 item difficulty
```{r}
df_vr_all %>%
  filter(difficulty == 3,
  error_type != "total_error") %>%
  ggplot(aes(error_value)) +
    geom_histogram(binwidth = 1) +
    scale_x_binned(breaks = seq(0, 3, 1)) +
    facet_wrap(~error_type)

df_vr_all %>%
  filter(difficulty == 3,
  error_type != "total_error") %>%
  count(error_type, error_value) %>%
  pivot_wider(names_from = error_value, values_from = n, values_fill = 0)

df_vr_all %>%
  filter(difficulty == 3,
  error_type != "total_error") %>%
  count(error_type, made_error) %>%
  pivot_wider(names_from = made_error, values_from = n, values_fill = 0, names_prefix = "error_") 
```

As almost no children made any errors in the 3 item difficulty, we considered them more as a training trial, then a real trial. For example 

### Removing the object location error

To simplify theoutput, we decided to keep only the object location error, as the object location and objec torder are heavilly correlated anyways

```{r object location order error corr}
df_location_object_error <- df_vr_all %>%
  filter(error_type %in% c("incorrect_location_order", "incorrect_object_order")) %>%
  select(-c(relative_error_value, made_error)) %>%
  pivot_wider(names_from = error_type, values_from = error_value)

df_location_object_error %>%
  ggplot(aes(incorrect_location_order, incorrect_object_order)) +
    geom_jitter() +
    geom_smooth(method = "lm") +
    labs(x = "Incorrect location order error", y = "Incorrect object order error", 
            title = "Correlation between incorrect location order error and incorrect object order error")
report::report(cor.test(df_location_object_error$incorrect_location_order, df_location_object_error$incorrect_object_order, 
method = "kendall"))
```

## Descriptives

```{r}
knitr::kable(head(df_vr))
```
```{r}
df_vr %>%
  select(name, age_months, gender) %>%
  distinct() %>%
  ggplot(aes(age_months, fill = gender)) +
    geom_histogram(binwidth = 3) + 
    labs(x = "Age (months)", y = "Count", 
    title = "Age distribution of participants")
```

### Errors 

::: {.callout-tip}

CO = correct objects/správné předměty resp. Jejich Chyby (už přepočítáno)

OPE = object position errors/chyby v pozici

OOE = object order errors/chyby v pořadí předmětu

LOE = location order errors/chyby v pořadí pozice
:::

These errors were renamed to a bit clearer naming schemes to prevent OOE, OPE etc.

::: {.callout-tip}
The errors come in four different types:

- selection error: the participant selected the wrong item

- incorrect_placement: the participant placed the item at a wrong position

- incorrect_object_order: the participant placed the item at a wrong order

- incorrect_location_order: the participant placed the item at a location in a wrong order?
:::

```{r error descriptives, echo = FALSE, message = FALSE}
df_error_desc <- df_vr %>%
  group_by(difficulty, error_type) %>%
  summarise(mean_error = mean(error_value), 
            sd_error = sd(error_value),
            sd_error_mean = sd(error_value) / sqrt(n()),
            min = min(error_value),
            max = max(error_value),
            median = median(error_value))

df_rel_error_desc <- df_vr %>%
  group_by(difficulty, error_type) %>%
  summarise(mean_error = mean(relative_error_value), 
            sd_error = sd(relative_error_value),
            sd_error_mean = sd(relative_error_value) / sqrt(n()),
            min = min(relative_error_value),
            max = max(relative_error_value),
            median = median(relative_error_value))

df_error_desc %>%
  select(-sd_error_mean) %>%
  gt() %>%
  tab_header(title = "Descriptives of error values in different difficulties and error types") %>%
  fmt_number(columns = where(is.numeric), decimals = 2)
```

```{r error descriptives plot}
df_error_desc %>%
  ggplot(aes(difficulty, mean_error, fill = error_type)) +
  geom_col(position = "dodge") +
  geom_errorbar(aes(ymin = mean_error - sd_error_mean, ymax = mean_error + sd_error_mean), 
                position = position_dodge(width = 0.9), width = 0.25) +
  labs(x = "Difficulty", y = "Mean error value", 
    title = "Mean error values in different difficulties and error types") 
```
### Relative error
As there is a difference in the potential number of errors possible at different difficulties, we also calculated the relative error value (error / difficulty). So the number 1 means the maximum number of errors possible at that difficulty.

```{r error relative descriptives plot}
df_rel_error_desc %>%
  ggplot(aes(error_type, mean_error, fill = factor(difficulty))) +
  geom_col(position = "dodge") +
  geom_errorbar(aes(ymin = mean_error - sd_error_mean, ymax = mean_error + sd_error_mean), 
                position = position_dodge(width = 0.9), width = 0.25) +
  labs(x = "Difficulty", y = "Mean relative error value",
       title = "Mean relative error values in different difficulties and error types") +
  #make the x labels 45 degrees
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

So it looks like increasing number of items also increases the general error. So children are probably not simply remembering the first three locations or objects, but just not remembering anything much at all. Average relative error for all types of errors is above 40 percent, with the exception of selection.


::: {.callout-warning}
The other very probably explanation is the dependency of the errors. If one location is incorrect, then more locations will be incorrect after that, as the participant will not be able to place the objects correctly. This will overestimate the number of errors, as the errors are not independent.

:::

## VR test results in different ages

```{r different ages and difficulties plot}
ggplot(df_vr, aes(age_months, relative_error_value, color = gender)) +
  geom_point() +
  facet_grid(rows = vars(difficulty), cols = vars(error_type), scales = "free_y") +
  geom_smooth(method = "lm") +
  labs(x = "Age (months)", y = "Relative error value (error / difficulty)", 
        title = "Relative error in individual error types and difficulties")
```

Overall there seems to be a trend of older children to make more mistakes, especially in the 4 items difficutly.

```{r different ages }
ggplot(df_vr, aes(age_months, relative_error_value, color = gender)) +
  geom_point() +
  facet_grid(cols = vars(error_type), scales = "free_y") +
  geom_smooth(method = "lm") +
  labs(x = "Age (months)", y = "Relative error value (error / difficulty)", 
        title = "Relative error in individual error types combined for both difficulties of 4 adn 5 items")
```

```{r logistic regression}
df_vr %>%
  mutate(made_error = as.numeric(made_error)) %>%
  ggplot(aes(age_months, made_error)) +
  geom_point() +
  facet_grid(rows = vars(difficulty), cols = vars(error_type), scales = "free_y") +
  stat_smooth(method="glm", color="green", se=FALSE, 
    method.args = list(family=binomial)) + 
    labs(x = "Age (months)", y = "Has the participant made any error", 
            title = "VR logistic regression of made error (error > 0) for each difficulty and error type")
``` 

Similar trend is even for the logistic regression modelling the likelihood of making any error. There seems to be an upward trend for older children to making errors more likely.

:::{.callout-note}
There are a few possible explanations

- the data are missing the time component, so we do not kno how long it actually took the children to answer or how much they moved in the environemnt

- It is possible, that the researcher might have been more supportive with the younger children

- Finally, it is possible that the researcher might have removed the cognitive load for the task for the young children (as is suggested in the thesis, that the reearcher kept helping children unable to control the environment on their own), but information about whom has been helped is missing. 
:::

## Correlation with other metrics

### Story repetition

Maximum points is 40 for the story repetition and 34 for the sentence repetition. Higher score is better.

```{r story repetition score plot}
df_all %>%
  ggplot(aes(error_value, NR)) +
  geom_point() +
    geom_smooth(method = "lm") +
  facet_grid(rows = vars(difficulty), cols = vars(error_type), scales = "free") + 
  labs(x = "Error value", y = "Story repetition score", 
            title = "Correlation between error value and story repetition score. Split by difficulty")

df_all %>%
  ggplot(aes(error_value, NR)) +
  geom_point() +
    geom_smooth(method = "lm") +
    facet_wrap(~error_type, scales = "free") +
    labs(x = "Error value", y = "Story repetition score", 
            title = "Correlation between error value and story repetition score")
```

```{r story repetition score}
df_all %>%
  group_by(error_type) %>%
  group_modify(~broom::tidy(cor.test(.$NR, .$error_value, method = "spearman"))) %>%
  select(estimate, statistic, p.value) %>%
  mutate(p.value = papaja::apa_p(p.adjust(p.value))) %>%
  ungroup() %>%
  gt() %>%
    tab_header(title = "Correlation between error value and story repetition score",
      subtitle = "Spearman correlation between error value and story repetition score for each error type") %>%
    fmt_number(columns = where(is.numeric), decimals = 2) %>%
    # add footnote corrected for mutliple comparisons to the header
    tab_footnote(
      footnote = "Corrected for multiple comparisons using FDR method",
      locations = cells_column_labels(vars(p.value))
    )
```

### Sentence repetition

```{r sentence repetition score plot}
df_all %>%
  ggplot(aes(error_value, SR)) +
  geom_point() +
    geom_smooth(method = "lm") +
facet_grid(rows = vars(difficulty), cols = vars(error_type), scales = "free") + 
  labs(x = "Error value", y = "Stentence repetition score", 
            title = "Correlation between error value and sentence repetition score. Split by difficulty")

df_all %>%
  ggplot(aes(error_value, SR)) +
  geom_point() +
    geom_smooth(method = "lm") +
    facet_wrap(~error_type, scales = "free") +
    labs(x = "Error value", y = "Sentence repetition score", 
            title = "Correlation between error value and sentence repetition score for all difficulties")
```

```{r sentence repetition score}
df_all %>%
  group_by(error_type) %>%
  group_modify(~broom::tidy(cor.test(.$SR, .$error_value, method = "spearman"))) %>%
  select(estimate, statistic, p.value) %>%
  mutate(p.value = papaja::apa_p(p.adjust(p.value))) %>%
  ungroup() %>%
  gt() %>%
    tab_header(title = "Correlation between error value and sentence repetition score",
      subtitle = "Spearman correlation between error value and stencence repetition score for each error type") %>%
    fmt_number(columns = where(is.numeric), decimals = 2) %>%
    # add footnote corrected for mutliple comparisons to the header
    tab_footnote(
      footnote = "Corrected for multiple comparisons using FDR method",
      locations = cells_column_labels(c(p.value))
    )
```

